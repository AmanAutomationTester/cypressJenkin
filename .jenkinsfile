pipeline
{
    agent any

    stages
    {
        // stage('Build')
        // {
        //     steps
        //     {
        //         bat "npm install"
        //         bat "exit 0"
        //     }
        // }
        // stage ('Test')
        // {
        //     steps
        //     {
        //         catchError (buildResult: 'SUCCESS', stageResult: 'FAILURE')
        //         {
        //             echo 'Executing spec file in Cypress'
        //             bat "npm test"
        //             bat "exit 1"
        //         }
        //     }
        // }
        // stage ('Read failures and write into CSV')
        // {
        //     steps
        //     {
        //         script {
        //             def files = findFiles(glob: '**/logs/*.json')
        //             def list = []
        //             files.each {
        //                 name -> def props = readJSON file: "${name}"                                             
        //                 list.add(props.title);
        //             }                      
        //             writeCSV file: 'fail.csv', records: list, format: CSVFormat.DEFAULT.withRecordSeparator(';'); 
        //             bat "exit 0"
        //         }
        //     }
        // }
        stage ('Rerun failed tests')
        {
            steps
            {
                script {
                    def records = readCSV file: 'fail.csv', skipFirstLine: true            
                    echo "aman singhal ${records}"
                    def testcases = records.values.flatten()
                    echo "megh ${testcases.flatten()}"
                    // str1 new = testcases.lstrip();
                    // echo "goyal ${new}"
                    // echo "aman singhal ${records.values.lstrip()}"       
                    bat "npx cypress run --env grep='${records.values.flatten()}'"          
                    bat "exit 0"
                }
            }
        }
    }
    // post {
    //     always {
    //         publishHTML(target: [
    //             allowMissing: false, 
    //             alwaysLinkToLastBuild: false, 
    //             keepAll: true, 
    //             reportDir: 'cypress/reports/mochawesome-report', 
    //             reportFiles: 'index.html', 
    //             reportName: 'My HTML Report'
    //         ])
    //     }
    // }
}
